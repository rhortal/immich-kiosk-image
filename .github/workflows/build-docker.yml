name: Build Docker Image

on:
  workflow_call:
    inputs:
      upstream_commit:
        description: 'Commit SHA from upstream repository'
        required: true
        type: string
      trigger_reason:
        description: 'Reason for triggering the build'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      upstream_commit:
        description: 'Commit SHA from upstream repository (optional)'
        required: false
        type: string
        default: 'latest'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get upstream repository info
        id: upstream-info
        run: |
          if [ -n "${{ inputs.upstream_commit }}" ] && [ "${{ inputs.upstream_commit }}" != "latest" ]; then
            # Validate commit SHA format (7-40 characters hex)
            if ! echo "${{ inputs.upstream_commit }}" | grep -qE '^[a-f0-9]{7,40}$'; then
              echo "Error: Invalid commit SHA format. Expected 7-40 character hexadecimal string."
              exit 1
            fi
            COMMIT_SHA="${{ inputs.upstream_commit }}"
          else
            # Get latest commit from upstream
            COMMIT_SHA=$(curl -s --max-time 30 --retry 3 -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/damongolding/immich-kiosk/commits/main | \
              jq -r '.sha')
            
            if [ "$COMMIT_SHA" = "null" ] || [ -z "$COMMIT_SHA" ]; then
              echo "Error: Could not fetch latest commit from upstream repository"
              exit 1
            fi
          fi
          
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          
          # Get commit timestamp for tagging
          TIMESTAMP=$(curl -s --max-time 30 --retry 3 -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/damongolding/immich-kiosk/commits/$COMMIT_SHA | \
            jq -r '.commit.committer.date' | \
            sed 's/[:T]//g' | sed 's/Z$//' | sed 's/-//g')
          
          if [ "$TIMESTAMP" = "null" ] || [ -z "$TIMESTAMP" ]; then
            echo "Error: Could not fetch commit timestamp"
            exit 1
          fi
          
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          
          # Get short commit SHA
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-8)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: https://github.com/damongolding/immich-kiosk.git#${{ steps.upstream-info.outputs.commit_sha }}
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ steps.upstream-info.outputs.short_sha }}
            ghcr.io/${{ github.repository }}:${{ steps.upstream-info.outputs.timestamp }}
          build-args: |
            VERSION=${{ steps.upstream-info.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Generate build summary
        run: |
          echo "## ðŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** damongolding/immich-kiosk" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ steps.upstream-info.outputs.commit_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger Reason:** ${{ inputs.trigger_reason || 'manual' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Built Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository }}:${{ steps.upstream-info.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`ghcr.io/${{ github.repository }}:${{ steps.upstream-info.outputs.timestamp }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Pull Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull latest" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Pull specific commit" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ github.repository }}:${{ steps.upstream-info.outputs.short_sha }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
      - name: Create GitHub Release (optional)
        if: inputs.trigger_reason == 'upstream_change'
        uses: actions/github-script@v7
        with:
          script: |
            const commitSha = '${{ steps.upstream-info.outputs.commit_sha }}';
            const shortSha = '${{ steps.upstream-info.outputs.short_sha }}';
            const timestamp = '${{ steps.upstream-info.outputs.timestamp }}';
            
            // Create a release tag
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/build-${shortSha}`,
                sha: context.sha
              });
              
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: `build-${shortSha}`,
                name: `Auto-build from upstream ${shortSha}`,
                body: `Automated Docker build triggered by upstream changes.\n\n**Upstream Commit:** ${commitSha}\n**Build Time:** ${new Date().toISOString()}\n\n**Docker Images:**\n- \`ghcr.io/${{ github.repository }}:latest\`\n- \`ghcr.io/${{ github.repository }}:${shortSha}\`\n- \`ghcr.io/${{ github.repository }}:${timestamp}\``,
                draft: false,
                prerelease: true
              });
            } catch (error) {
              console.log('Release creation failed (might already exist):', error.message);
            }