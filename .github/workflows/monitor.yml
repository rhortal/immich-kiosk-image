name: Monitor Upstream Repository

on:
  # schedule:
  #   # Run daily at midnight UTC
  #   - cron: '0 0 * * *'
  workflow_dispatch:  # Allow manual triggering

permissions:
  actions: write
  contents: write
  packages: write

jobs:
  monitor:
    runs-on: ubuntu-latest
    outputs:
      upstream_commit: ${{ steps.check-upstream.outputs.latest_commit }}
      changes_detected: ${{ steps.check-upstream.outputs.changes_detected }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Get latest upstream commit
        id: check-upstream
        run: |
          # Get the latest commit SHA from the upstream repository
          LATEST_COMMIT=$(curl -s --max-time 30 --retry 3 -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/damongolding/immich-kiosk/commits/main | \
            jq -r '.sha')
          
          if [ "$LATEST_COMMIT" = "null" ] || [ -z "$LATEST_COMMIT" ]; then
            echo "Error: Could not fetch latest commit from upstream repository"
            exit 1
          fi
          
          echo "Latest upstream commit: $LATEST_COMMIT"
          echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          
          # Check if we have a previous commit stored
          if [ -f ".last-commit" ]; then
            LAST_COMMIT=$(cat .last-commit)
            echo "Last known commit: $LAST_COMMIT"
            
            if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
              echo "No changes detected"
              echo "changes_detected=false" >> $GITHUB_OUTPUT
            else
              echo "Changes detected!"
              echo "changes_detected=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "First run - will trigger build"
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          fi
          
      

  build:
    if: needs.monitor.outputs.changes_detected == 'true'
    needs: monitor
    uses: ./.github/workflows/build-docker.yml
    with:
      upstream_commit: ${{ needs.monitor.outputs.upstream_commit }}
      trigger_reason: upstream_change

  update-commit-tracking:
    if: needs.build.result == 'success'
    needs: [monitor, build]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Update tracked commit after successful build
        run: |
          echo "${{ needs.monitor.outputs.upstream_commit }}" > .last-commit
          
      - name: Commit updated commit SHA
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add -f .last-commit
          git diff --staged --quiet || git commit -m "Update tracked commit to ${{ needs.monitor.outputs.upstream_commit }} after successful build"
          
          # Retry push with exponential backoff
          for i in {1..3}; do
            if git push; then
              echo "Push successful on attempt $i"
              break
            else
              echo "Push failed on attempt $i, retrying in $((i * 5)) seconds..."
              sleep $((i * 5))
              git pull --rebase || true
            fi
          done